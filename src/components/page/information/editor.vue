<template>
  <div>
    <textarea :id="Id"></textarea>
  </div>
</template>
<script>
import '../../../../static/tinymce/tinymce.min.js'
import formJs from "./upload"
let app_config = require('../../../../static/ApplicationConfig')

export default {
  name: 'mceeditor',
  data() {
    const Id = Date.now()
    return {
      Id: Id,
      Editor: [],
      DefaultConfig: {
        // GLOBAL
        language: 'zh_CN',
        height: 200,
        theme: 'modern',
        menubar: false,
        toolbar: `styleselect | fontselect | formatselect | fontsizeselect | forecolor backcolor | bold italic underline strikethrough | image  media | table | alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist | preview removeformat  hr | paste code  link | undo redo | save `,
        plugins: `
            paste
            importcss
            image
            code
            table
            advlist
            link
            media
            lists
            textcolor
            colorpicker
            hr
            preview,
            save
          `,

        // CONFIG
        forced_root_block: 'p',
        force_p_newlines: true,
        importcss_append: true,
        // CONFIG: ContentStyle 这块很重要， 在最后呈现的页面也要写入这个基本样式保证前后一致， `table`和`img`的问题基本就靠这个来填坑了
        content_style: `
            *                         { padding:0; margin:0; }
            html, body                { height:100%; }
            img                       { max-width:100%; display:block;height:auto; }
            a                         { text-decoration: none; }
            iframe                    { width: 100%; }
            p                         { line-height:1.6; margin: 0px; }
            table                     { word-wrap:break-word; word-break:break-all; max-width:100%; border:none; border-color:#999; }
            .mce-object-iframe        { width:100%; box-sizing:border-box; margin:0; padding:0; }
            ul,ol                     { list-style-position:inside; }
          `,
        insert_button_items: 'image link | inserttable',
        // CONFIG: Paste
        paste_retain_style_properties: 'all',
        paste_word_valid_elements: '*[*]',        // word需要它
        paste_data_images: true,                  // 粘贴的同时能把内容里的图片自动上传，非常强力的功能
        paste_convert_word_fake_lists: false,     // 插入word文档需要该属性
        paste_webkit_styles: 'all',
        paste_merge_formats: true,
        nonbreaking_force_tab: false,
        paste_auto_cleanup_on_paste: false,
        // CONFIG: Font
        fontsize_formats: '10px 11px 12px 14px 16px 18px 20px 24px',
        // CONFIG: StyleSelect
        style_formats: [
          {
            title: '首行缩进',
            block: 'p',
            styles: { 'text-indent': '2em' }
          },
          {
            title: '行高',
            items: [
              { title: '1', styles: { 'line-height': '1' }, inline: 'span' },
              { title: '1.5', styles: { 'line-height': '1.5' }, inline: 'span' },
              { title: '2', styles: { 'line-height': '2' }, inline: 'span' },
              { title: '2.5', styles: { 'line-height': '2.5' }, inline: 'span' },
              { title: '3', styles: { 'line-height': '3' }, inline: 'span' }
            ]
          }
        ],
        // FontSelect
        font_formats: `
            微软雅黑=微软雅黑;
            宋体=宋体;
            黑体=黑体;
            仿宋=仿宋;
            楷体=楷体;
            隶书=隶书;
            幼圆=幼圆;
            Andale Mono=andale mono,times;
            Arial=arial, helvetica,
            sans-serif;
            Arial Black=arial black, avant garde;
            Book Antiqua=book antiqua,palatino;
            Comic Sans MS=comic sans ms,sans-serif;
            Courier New=courier new,courier;
            Georgia=georgia,palatino;
            Helvetica=helvetica;
            Impact=impact,chicago;
            Symbol=symbol;
            Tahoma=tahoma,arial,helvetica,sans-serif;
            Terminal=terminal,monaco;
            Times New Roman=times new roman,times;
            Trebuchet MS=trebuchet ms,geneva;
            Verdana=verdana,geneva;
            Webdings=webdings;
            Wingdings=wingdings,zapf dingbats`,
        // Tab
        tabfocus_elements: ':prev,:next',
        object_resizing: true,
        // Image
        imagetools_toolbar: 'rotateleft rotateright | flipv fliph | editimage imageoptions'
      }
    }
  },
  props: {
    value: {
      default: '',
      type: String
    },
    config: {
      type: Object,
      default: () => {
        return {
          theme: 'modern',
          height: 300
        }
      }
    },
    url: {
      default: '',
      type: String
    },
    accept: {
      default: 'image/jpeg, image/png',
      type: String
    },
    maxSize: {
      default: 2097152,
      type: Number
    },
    withCredentials: {
      default: false,
      type: Boolean
    }
  },
  mounted() {
    this.init()
  },
  // beforeDestroy() {
  //   // 销毁tinymce
  //   this.$emit('on-destroy')
  //   window.tinymce.remove(`$#{this.Id}`)
  // },
  methods: {
    init() {
      const self = this
      this.Editor = window.tinymce.init({
        // 默认配置
        // ...this.DefaultConfig,

          // GLOBAL
          language: 'zh_CN',
          height: 200,
          theme: 'modern',
          menubar: false,
          toolbar: `styleselect | fontselect | formatselect | fontsizeselect | forecolor backcolor | bold italic underline strikethrough | image  media | table | alignleft aligncenter alignright alignjustify | outdent indent | numlist bullist | preview removeformat  hr | paste code  link | undo redo | save `,
          plugins: `
            paste
            importcss
            image
            code
            table
            advlist
            link
            media
            lists
            textcolor
            colorpicker
            hr
            preview,
            save
          `,

          // CONFIG
          forced_root_block: 'p',
          force_p_newlines: true,
          importcss_append: true,
          // media_live_embeds:true,
          // CONFIG: ContentStyle 这块很重要， 在最后呈现的页面也要写入这个基本样式保证前后一致， `table`和`img`的问题基本就靠这个来填坑了
          content_style: `
            *                         { padding:0; margin:0; }
            html, body                { height:100%; }
            img                       { max-width:100%; display:block;height:auto; }
            a                         { text-decoration: none; }
            iframe                    { width: 100%; }
            p                         { line-height:1.6; margin: 0px; }
            table                     { word-wrap:break-word; word-break:break-all; max-width:100%; border:none; border-color:#999; }
            .mce-object-iframe        { width:100%; box-sizing:border-box; margin:0; padding:0; }
            ul,ol                     { list-style-position:inside; }
          `,
          insert_button_items: 'image link | inserttable',
          // CONFIG: Paste
          paste_retain_style_properties: 'all',
          paste_word_valid_elements: '*[*]',        // word需要它
          paste_data_images: true,                  // 粘贴的同时能把内容里的图片自动上传，非常强力的功能
          paste_convert_word_fake_lists: false,     // 插入word文档需要该属性
          paste_webkit_styles: 'all',
          paste_merge_formats: true,
          nonbreaking_force_tab: false,
          paste_auto_cleanup_on_paste: false,
          // CONFIG: Font
          fontsize_formats: '10px 11px 12px 14px 16px 18px 20px 24px',
          // CONFIG: StyleSelect
          style_formats: [
            {
              title: '首行缩进',
              block: 'p',
              styles: { 'text-indent': '2em' }
            },
            {
              title: '行高',
              items: [
                { title: '1', styles: { 'line-height': '1' }, inline: 'span' },
                { title: '1.5', styles: { 'line-height': '1.5' }, inline: 'span' },
                { title: '2', styles: { 'line-height': '2' }, inline: 'span' },
                { title: '2.5', styles: { 'line-height': '2.5' }, inline: 'span' },
                { title: '3', styles: { 'line-height': '3' }, inline: 'span' }
              ]
            }
          ],
          // FontSelect
          font_formats: `
            微软雅黑=微软雅黑;
            宋体=宋体;
            黑体=黑体;
            仿宋=仿宋;
            楷体=楷体;
            隶书=隶书;
            幼圆=幼圆;
            Andale Mono=andale mono,times;
            Arial=arial, helvetica,
            sans-serif;
            Arial Black=arial black, avant garde;
            Book Antiqua=book antiqua,palatino;
            Comic Sans MS=comic sans ms,sans-serif;
            Courier New=courier new,courier;
            Georgia=georgia,palatino;
            Helvetica=helvetica;
            Impact=impact,chicago;
            Symbol=symbol;
            Tahoma=tahoma,arial,helvetica,sans-serif;
            Terminal=terminal,monaco;
            Times New Roman=times new roman,times;
            Trebuchet MS=trebuchet ms,geneva;
            Verdana=verdana,geneva;
            Webdings=webdings;
            Wingdings=wingdings,zapf dingbats`,
        // Tab
        tabfocus_elements: ':prev,:next',
        object_resizing: true,
        // Image
        imagetools_toolbar: 'rotateleft rotateright | flipv fliph | editimage imageoptions',
        imagetools_cors_hosts: ['wpimg.wallstcn.com', 'wallstreetcn.com'],
        //链接打开方式
        default_link_target: '_blank',
        images_upload_url: '/tinymce',
        file_picker_types: 'media',
        file_picker_callback: function(cb, value, meta) {
          //当点击meidia图标上传时,判断meta.filetype == 'media'有必要，因为file_picker_callback是media(媒体)、image(图片)、file(文件)的共同入口
          if (meta.filetype == 'media'){
            //创建一个隐藏的type=file的文件选择input
            let input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.onchange = function(){
              let file = this.files[0];//只选取第一个文件。如果要选取全部，后面注意做修改
              uploadFile(file)
            }
            //触发点击
            input.click();
          }
          function uploadFile(file) {
            var that=this;
            // const xhr = new XMLHttpRequest()
            const formData = new FormData()
            // xhr.withCredentials = false
            formData.append('file', file)
            formData.append('fileName', '11')
            // axios 请求方式 自己定义

            formJs.uploadFile(formData).then(res => {
              if (res.code === 0) {
                debugger;
                cb('http://10.0.200.26'+ '/' + res.data.locationUrl, { title: file.name }) // 成功的回调
                self.$emit('on-upload-complete', res) // 回调结果抛出钩子函数
              } else {
                self.$emit('on-upload-complete', res)  // 抛出 'on-upload-complete' 钩子
              }
            })
          }
        },
        video_template_callback: function(data) {
          data.width = "98%";
          data.height = "auto";
          return `<p>
               <span class="mce-preview-object mce-object-video" contenteditable="false"
               data-mce-object="video" data-mce-p-allowfullscreen="allowfullscreen"
               data-mce-p-frameborder="no" data-mce-p-scrolling="no"
               data-mce-p-src=${data.source1}
               data-mce-p-width=${data.width}
               data-mce-p-height=${data.height}
               data-mce-p-controls="controls" data-mce-html="%20">
                 <video width=${data.width} height=${data.height} controls="controls">
                  <source src=${data.source1} type=${data.source1mime}></source>
                 </video>
               </span>
            </p>`;
        },
        // 图片上传
        images_upload_handler: function (blobInfo, success, failure) {
          if (blobInfo.blob().size > self.maxSize) {
            failure('文件体积过大')
          }
          if (self.accept.indexOf(blobInfo.blob().type) > 0) {
            uploadPic()
          } else {
            failure('图片格式错误')
          }
          function uploadPic() {
            // const xhr = new XMLHttpRequest()
            const formData = new FormData()
            // xhr.withCredentials = false
            formData.append('file', blobInfo.blob())
            formData.append('fileName',blobInfo.filename())
            // axios 请求方式 自己定义

            formJs.uploadImage(formData).then(res => {
              if (res.code === 0) {
                 debugger;
                success('http://10.0.200.26' + '/' + res.data.locationUrl) // 成功的回调
                self.$emit('on-upload-complete', res) // 回调结果抛出钩子函数
              } else {
                failure('上传失败: ')
                self.$emit('on-upload-complete', res)  // 抛出 'on-upload-complete' 钩子
              }
            })
            // xhr.open('POST', globals.host + '/common/image')
            // xhr.onload = function () {
            //   if (xhr.status !== 200) {
            //     // 抛出 'on-upload-fail' 钩子
            //     self.$emit('on-upload-fail')
            //     failure('上传失败: ' + xhr.status)
            //     return
            //   }
            //   const json = JSON.parse(xhr.responseText)
            //   // 抛出 'on-upload-complete' 钩子
            //   self.$emit('on-upload-complete', [
            //     json, success, failure
            //   ])
            // }
            // xhr.send(formData)
          }
        },
        init_instance_callback: editor => {
          if (self.value) {
            editor.setContent(self.value)
          }
          self.hasInit = true
          editor.on('NodeChange Change input KeyUp', () => {
            //change触发watch去setContent，光标变化了，
            this.hasChange = true
            this.$emit('input', editor.getContent({ format: 'raw' }))
          })
        },
        // prop内传入的的config
        // ...this.config,
        //保存回调函数
        save_onsavecallback:function(){
          self.$emit('save-value')
        },

        // 挂载的DOM对象
        selector: `#${this.Id}`,
        setup: (editor) => {
          // 抛出 'on-ready' 事件钩子
          editor.on(
            'init', () => {
              self.loading = false
              self.$emit('on-ready')
              editor.setContent(self.value)
            }
          )
          // 抛出 'input' 事件钩子，同步value数据
          editor.on(
            'input change undo redo', () => {
              self.$emit('input', editor.getContent())
            }
          )
        }
      })
    }
  }
}
</script>
